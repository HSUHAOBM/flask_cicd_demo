name: Deploy to Linode

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # æŠŠ repo çš„ç¨‹å¼ç¢¼ clone åˆ° runner ä¸Š
      - name: Checkout Code
        uses: actions/checkout@v2

      # è¨­å®š Python ç’°å¢ƒ
      - name: Set Python version
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'

      # åŸ·è¡Œæ¸¬è©¦
      - name: Run Tests
        run: |
          pip install -r requirements.txt
          pytest

      # Bandit å®‰å…¨æª¢æŸ¥
      - name: Bandit Slack Notify Summary
        run: |
          pip install bandit
          bandit -r app/ | tee bandit_report.txt

          issues_high=$(grep -c "Severity: High" bandit_report.txt)
          issues_medium=$(grep -c "Severity: Medium" bandit_report.txt)
          run_url="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          curl -X POST -H "Content-type: application/json" --data "{
            \"text\": \"ğŸ” Bandit æƒæå®Œæˆï¼š\\n- é«˜é¢¨éšªï¼š$issues_high\\n- ä¸­é¢¨éšªï¼š$issues_medium\\nğŸ“¦ é»æ­¤æŸ¥çœ‹å ±å‘Šèˆ‡ logï¼š$run_url\"
          }" ${{ secrets.SLACK_WEBHOOK_URL }}

      # éƒ¨å±¬åˆ° Linode
      - name: Deploy to Linode
        if: success() # åªæœ‰åœ¨æ¸¬è©¦æˆåŠŸæ™‚æ‰æœƒåŸ·è¡Œé€™ä¸€æ­¥
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.LINODE_HOST }}
          username: ${{ secrets.LINODE_USERNAME }}
          key: ${{ secrets.LINODE_SSHKEY }}
          script: |
            cd ${{ secrets.LINODE_PROJECT_PATH }}
            git pull
            docker compose down
            docker compose up -d --

      # Notify Slack on Success
      - name: Slack Notify Success
        if: success()
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{
            "attachments": [
              {
                "color": "good",
                "title": "âœ… CI/CD æˆåŠŸéƒ¨ç½²åˆ° Linode",
                "fields": [
                  {
                    "title": "Repo",
                    "value": "${{ github.repository }}",
                    "short": true
                  },
                  {
                    "title": "Branch",
                    "value": "${{ github.ref_name }}",
                    "short": true
                  },
                  {
                    "title": "Commit",
                    "value": "<https://github.com/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>"
                  },
                  {
                    "title": "ä½œè€…",
                    "value": "${{ github.actor }}"
                  }
                ]
              }
            ]
          }' ${{ secrets.SLACK_WEBHOOK_URL }}
      # Notify Slack on Failure
      - name: Slack Notify Failure
        if: failure()
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{
            "attachments": [
              {
                "color": "danger",
                "title": "âŒ CI/CD å¤±æ•—",
                "fields": [
                  {
                    "title": "Repo",
                    "value": "${{ github.repository }}",
                    "short": true
                  },
                  {
                    "title": "Branch",
                    "value": "${{ github.ref_name }}",
                    "short": true
                  },
                  {
                    "title": "Commit",
                    "value": "<https://github.com/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>"
                  },
                  {
                    "title": "ä½œè€…",
                    "value": "${{ github.actor }}"
                  }
                ]
              }
            ]
          }' ${{ secrets.SLACK_WEBHOOK_URL }}